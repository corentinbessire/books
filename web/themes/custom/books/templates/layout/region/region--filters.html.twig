{% if content %}
  <div class="mb-6" x-data="activeFilters()" x-init="init()">
    <!-- Active Filters Display -->
    <div class="py-3 px-4 bg-cream border border-stone-300 rounded-lg mb-4" x-show="selectedFilters.length > 0" x-cloak>
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm text-ink-muted font-medium" style="font-family: var(--font-accent);">Active filters:</span>
        <template x-for="filter in selectedFilters" :key="filter.id">
          <button
            type="button"
            class="inline-flex items-center gap-1.5 py-1.5 px-3 bg-burgundy text-white text-[0.8125rem] font-medium rounded-full cursor-pointer transition-colors duration-200 hover:bg-burgundy-dark"
            @click="removeFilter(filter)"
            :title="'Remove ' + filter.label">
            <span x-text="filter.label"></span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </template>
        <button
          type="button"
          class="text-sm text-burgundy hover:text-burgundy-dark underline transition-colors"
          @click="clearAll()"
          x-show="selectedFilters.length > 1">
          Clear all
        </button>
      </div>
    </div>

    <!-- Filter Panel -->
    <div class="bg-cream border border-stone-300 rounded-lg overflow-hidden" x-data="{ isOpen: false }">
      <!-- Filter Toggle Header -->
      <button
        type="button"
        class="flex items-center justify-between w-full py-4 px-6 bg-cream border-b border-stone-300 cursor-pointer transition-colors duration-300 hover:bg-stone-200"
        @click="isOpen = !isOpen"
        :aria-expanded="isOpen">
        <span class="text-sm font-semibold tracking-[0.1em] uppercase text-ink-muted" style="font-family: var(--font-accent);">Filters</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 text-ink-muted transition-transform duration-300"
          :class="{ 'rotate-180': isOpen }"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <!-- Filter Content -->
      <div
        class="py-4 px-6 bg-cream"
        x-show="isOpen"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 -translate-y-2"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 -translate-y-2"
        x-cloak>
        <div class="grid md:grid-cols-2 gap-6">
          {% if elements.authors %}
            <div>
              {{ elements.authors }}
            </div>
          {% endif %}
          {% if elements.genres %}
            <div>
              {{ elements.genres }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    function activeFilters() {
      return {
        selectedFilters: [],
        init() {
          // Run immediately and also after a short delay for Drupal AJAX/BigPipe
          this.updateFilters();
          setTimeout(() => this.updateFilters(), 100);
          // Also listen for Drupal behaviors attachment
          document.addEventListener('drupalBehaviorsAttached', () => this.updateFilters());
        },
        updateFilters() {
          this.selectedFilters = [];

          // Find checked checkboxes (Drupal Facets checkbox widget)
          this.$el.querySelectorAll('input[type="checkbox"]:checked').forEach((checkbox) => {
            // Get label from the sibling label element (cleaner than li.textContent)
            const labelEl = checkbox.nextElementSibling;
            let label = labelEl ? labelEl.textContent.trim() : '';

            // Clean up label - remove count like (14) at the end
            label = label.replace(/\s*\(\d+\)\s*$/, '').trim();

            if (label && !this.selectedFilters.find(f => f.label === label)) {
              this.selectedFilters.push({
                id: 'filter-' + this.selectedFilters.length,
                label: label,
                url: null,
                element: checkbox
              });
            }
          });

          // Also find active link-based facets (for non-checkbox facet widgets)
          this.$el.querySelectorAll('label.is-active, li.is-active > a, .facet-item--active > a').forEach((el) => {
            if (el.tagName === 'LABEL') {
              // Skip labels for checkboxes we already processed
              const checkbox = el.previousElementSibling;
              if (checkbox && checkbox.type === 'checkbox' && checkbox.checked) return;
            }

            let label = el.textContent.trim();
            label = label.replace(/\s*\(\d+\)\s*$/, '').replace(/^\s*\(-\)\s*/, '').trim();
            const url = el.href || null;

            if (label && !this.selectedFilters.find(f => f.label === label)) {
              this.selectedFilters.push({
                id: 'filter-' + this.selectedFilters.length,
                label: label,
                url: url,
                element: el
              });
            }
          });
        },
        removeFilter(filter) {
          if (filter.element && filter.element.type === 'checkbox') {
            filter.element.click();
          } else if (filter.url) {
            window.location.href = filter.url;
          } else if (filter.element) {
            filter.element.click();
          }
        },
        clearAll() {
          const baseUrl = window.location.pathname;
          window.location.href = baseUrl;
        }
      };
    }
  </script>
{% endif %}
