name: CI

on:
  pull_request:
    branches: [main, stage, develop]
  push:
    branches: [main, stage, develop]
    tags: ['*']

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '24'
  THEME_ROOT: 'web/themes/custom/books'

jobs:
  composer:
    name: Composer Install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Validate composer.json
        run: composer validate --no-check-all --ansi

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader --ignore-platform-reqs

      - name: Cache installed vendor
        uses: actions/cache/save@v4
        with:
          path: |
            vendor
            web/autoload.php
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          key: vendor-installed-${{ github.run_id }}

  npm:
    name: Theme Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.THEME_ROOT }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.THEME_ROOT }}
        run: npm ci

      - name: Build theme
        working-directory: ${{ env.THEME_ROOT }}
        run: npm run build

  phpcs:
    name: PHPCS
    runs-on: ubuntu-latest
    needs: composer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Restore installed vendor
        uses: actions/cache/restore@v4
        with:
          path: |
            vendor
            web/autoload.php
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          key: vendor-installed-${{ github.run_id }}

      - name: Run PHPCS
        run: |
          php vendor/bin/phpcs -p --colors \
            --standard="Drupal,DrupalPractice" \
            --extensions="php,inc,module,install,test,profile,theme" \
            --ignore='web/core,**/node_modules/**' \
            web/**/custom

  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest
    needs: composer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Restore installed vendor
        uses: actions/cache/restore@v4
        with:
          path: |
            vendor
            web/autoload.php
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          key: vendor-installed-${{ github.run_id }}

      - name: Run PHPStan
        run: |
          php vendor/bin/phpstan analyze web/**/custom \
            --no-progress \
            --configuration phpstan.neon \
            --error-format table \
            --memory-limit 4G

  phpunit-unit:
    name: PHPUnit (Unit)
    runs-on: ubuntu-latest
    needs: composer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Restore installed vendor
        uses: actions/cache/restore@v4
        with:
          path: |
            vendor
            web/autoload.php
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          key: vendor-installed-${{ github.run_id }}

      - name: Run PHPUnit unit tests
        run: php vendor/bin/phpunit --testsuite unit --no-progress --colors=always

  phpunit-kernel:
    name: PHPUnit (Kernel)
    runs-on: ubuntu-latest
    needs: composer
    services:
      mysql:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: drupal
        ports:
          - 3306:3306
        options: --health-cmd="mariadb-admin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Restore installed vendor
        uses: actions/cache/restore@v4
        with:
          path: |
            vendor
            web/autoload.php
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          key: vendor-installed-${{ github.run_id }}

      - name: Run PHPUnit kernel tests
        env:
          SIMPLETEST_DB: mysql://root:root@127.0.0.1:3306/drupal
          SIMPLETEST_BASE_URL: http://localhost
        run: php vendor/bin/phpunit --testsuite kernel --no-progress --colors=always

  phpunit-functional:
    name: PHPUnit (Functional)
    runs-on: ubuntu-latest
    needs: composer
    services:
      mysql:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: drupal
        ports:
          - 3306:3306
        options: --health-cmd="mariadb-admin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Restore installed vendor
        uses: actions/cache/restore@v4
        with:
          path: |
            vendor
            web/autoload.php
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          key: vendor-installed-${{ github.run_id }}

      - name: Start PHP built-in server
        run: php -S localhost:8080 -t web &

      - name: Run PHPUnit functional tests
        env:
          SIMPLETEST_DB: mysql://root:root@127.0.0.1:3306/drupal
          SIMPLETEST_BASE_URL: http://localhost:8080
        run: php vendor/bin/phpunit --testsuite functional --no-progress --colors=always
