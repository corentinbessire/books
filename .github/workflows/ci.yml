name: CI

on:
  pull_request:
    branches: [main, stage, develop]
  push:
    branches: [main, stage, develop]
    tags: ['*']

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '22'
  THEME_ROOT: 'web/themes/custom/books'

jobs:
  composer:
    name: Composer Install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Validate composer.json
        run: composer validate --no-check-all --ansi

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader --ignore-platform-reqs

      - name: Upload vendor artifact
        uses: actions/upload-artifact@v4
        with:
          name: vendor
          path: |
            vendor
            web/core
            web/modules/contrib
            web/profiles/contrib
            web/themes/contrib
            web/libraries
            drush/Commands
          retention-days: 1

  npm:
    name: Theme Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.THEME_ROOT }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.THEME_ROOT }}
        run: npm ci

      - name: Build theme
        working-directory: ${{ env.THEME_ROOT }}
        run: npm run build

      - name: Upload theme artifact
        uses: actions/upload-artifact@v4
        with:
          name: theme
          path: ${{ env.THEME_ROOT }}
          retention-days: 1

  phpcs:
    name: PHPCS
    runs-on: ubuntu-latest
    needs: composer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Download vendor artifact
        uses: actions/download-artifact@v4
        with:
          name: vendor
          path: .

      - name: Run PHPCS
        run: |
          php vendor/bin/phpcs -p --colors \
            --standard="Drupal,DrupalPractice" \
            --extensions="php,inc,module,install,test,profile,theme" \
            --ignore='web/core,**/node_modules/**' \
            web/**/custom

  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest
    needs: composer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, pdo_mysql, gd
          coverage: none

      - name: Download vendor artifact
        uses: actions/download-artifact@v4
        with:
          name: vendor
          path: .

      - name: Run PHPStan
        run: |
          php vendor/bin/phpstan analyze web/**/custom \
            --no-progress \
            --configuration phpstan.neon \
            --error-format table \
            --memory-limit 4G
